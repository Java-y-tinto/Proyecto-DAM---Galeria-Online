name: Backend CI

on:
  push:
    branches:
      - main
      - master

jobs:
  test-backend:
    runs-on: ubuntu-latest

    services:
        db:
          image: postgres:15
          env:
            POSTGRES_DB: postgres
            POSTGRES_USER: odoo
            POSTGRES_PASSWORD: odoo
          ports:
            - 5432:5432
          options: >-
            --health-cmd="pg_isready -U odoo"
            --health-interval=10s
            --health-timeout=5s
            --health-retries=5
        odoo:
          image: odoo:18.0
          ports:
            - 8069:8069
          env:
            HOST: db
            USER: odoo
            PASSWORD: odoo
          
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
       
      - name: prueba
        run: docker ps



      - name: Instalar dependencias middleware
        working-directory: middleware
        run: npm ci --omit=dev
      
      - name: Compilar middleware
        working-directory: middleware
        run: npm run compile
      
      - name: Verificar que odoo esta corriendo
        run: curl -f http://localhost:8069/web/health
      
      - name: Inicializar base de datos Odoo con datos demo
        run: |
         docker exec $(docker ps -qf "ancestor=odoo:18.0") \
          odoo -d odoo_test \
           -i base \
          --without-demo=False \
          --stop-after-init \
          --log-level=info
        
     
    