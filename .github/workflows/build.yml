name: Node.js CI

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

env:
  NODE_VERSION: '20'

concurrency: 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-middleware:
    name: ğŸ§ª Test Middleware + Odoo Integration
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: middleware/package-lock.json

    - name: ğŸ³ Setup Docker y Docker Compose
      uses: docker/setup-compose-action@v1
      with:
          version: latest

    - name: ğŸ”§ Configurar variables de entorno para testing
      working-directory: ./middleware
      run: |
        echo "ğŸ”§ Creando archivo .env para testing..."
        cat > .env << 'EOF'
        # ConfiguraciÃ³n para CI/Testing
        NODE_ENV=test
        CI=true
        
        # Odoo Configuration
        ODOO_BASE_URL=http://localhost
        ODOO_PORT=8069
        ODOO_DB=postgres
        ODOO_USERNAME=admin
        ODOO_PASSWORD=admin
        
        # JWT Configuration
        JWT_SECRET=test-jwt-secret-key-for-ci-testing-2024
        JWT_EXPIRES_IN=2h
        
        # Puerto del middleware
        PORT=4000
        EOF

    - name: ğŸ“¦ Instalar dependencias del middleware
      working-directory: ./middleware
      run: |
        echo "ğŸ“¦ Instalando dependencias del middleware..."
        npm ci

    - name: ğŸ”¨ Compilar TypeScript
      working-directory: ./middleware
      run: |
        echo "ğŸ”¨ Compilando TypeScript..."
        npm run compile

    - name: ğŸš€ Iniciar servicios con Docker Compose
      working-directory: ./backend
      run: |
        echo "ğŸš€ Iniciando Odoo y PostgreSQL con Docker Compose..."
        docker compose up -d db odoo
        
        echo "â³ Esperando que PostgreSQL estÃ© listo..."
        timeout 60 bash -c 'until docker compose exec -T db pg_isready -U odoo; do 
          echo "â³ Esperando PostgreSQL... ($(date))"
          sleep 3
        done'
        
        echo "â³ Esperando que Odoo estÃ© listo..."
        timeout 180 bash -c 'until curl -f http://localhost:8069/web/health > /dev/null 2>&1; do 
          echo "â³ Esperando Odoo... ($(date))"
          sleep 5
        done'
        
        echo "âœ… Servicios iniciados correctamente"

    - name: ğŸ“‹ Mostrar logs de servicios
      working-directory: ./backend
      if: always()
      run: |
        echo "ğŸ“‹ Logs de PostgreSQL:"
        docker compose logs db | tail -20
        echo ""
        echo "ğŸ“‹ Logs de Odoo:"
        docker compose logs odoo | tail -30

    - name: ğŸ­ Configurar Odoo y datos de prueba
      working-directory: ./middleware
      env:
        NODE_ENV: test
        CI: true
        ODOO_BASE_URL: http://localhost
        ODOO_PORT: 8069
        ODOO_DB: postgres
        ODOO_USERNAME: odoo
        ODOO_PASSWORD: odoo
        JWT_SECRET: test-jwt-secret-key-for-ci-testing-2024
        JWT_EXPIRES_IN: 2h
      run: |
        echo "ğŸ­ Configurando Odoo para testing usando script dedicado..."
        npm run setup:ci

    - name: ğŸ§ª Ejecutar tests de integraciÃ³n
      working-directory: ./middleware
      timeout-minutes: 15
      env:
        NODE_ENV: test
        CI: true
        ODOO_BASE_URL: http://localhost
        ODOO_PORT: 8069
        ODOO_DB: postgres
        ODOO_USERNAME: odoo
        ODOO_PASSWORD: odoo
        JWT_SECRET: test-jwt-secret-key-for-ci-testing-2024
        JWT_EXPIRES_IN: 2h
      run: |
        echo "ğŸ§ª Ejecutando tests de integraciÃ³n del middleware..."
        echo "ğŸ”§ Variables de entorno configuradas:"
        echo "   - NODE_ENV: $NODE_ENV"
        echo "   - ODOO_BASE_URL: $ODOO_BASE_URL"
        echo "   - ODOO_PORT: $ODOO_PORT" 
        echo "   - ODOO_DB: $ODOO_DB"
        echo "   - ODOO_USERNAME: $ODOO_USERNAME"
        
        npm run test

    - name: ğŸ“Š Subir reporte de cobertura
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-middleware
        path: middleware/coverage/
        retention-days: 30

    - name: ğŸ“‹ Mostrar logs de servicios si hay fallos
      working-directory: ./backend
      if: failure()
      run: |
        echo "ğŸ“‹ Logs de PostgreSQL:"
        docker compose logs db
        echo ""
        echo "ğŸ“‹ Logs de Odoo:"
        docker compose logs odoo

    - name: ğŸ§¹ Limpiar servicios
      working-directory: ./backend
      if: always()
      run: |
        echo "ğŸ§¹ Limpiando servicios Docker..."
        docker compose down -v
        docker system prune -f

  test-frontend:
    name: ğŸ¨ Test Frontend Angular
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ“¦ Instalar dependencias del frontend
      working-directory: ./frontend
      run: |
        echo "ğŸ“¦ Instalando dependencias del frontend..."
        npm ci

    - name: ğŸ” Lint del cÃ³digo
      working-directory: ./frontend
      run: |
        echo "ğŸ” Ejecutando lint..."
        npm run lint || echo "âš ï¸ Lint completado con warnings"

    - name: ğŸ”¨ Build de producciÃ³n
      working-directory: ./frontend
      run: |
        echo "ğŸ”¨ Construyendo frontend para producciÃ³n..."
        npm run build

    - name: ğŸ§ª Tests unitarios
      working-directory: ./frontend
      run: |
        echo "ğŸ§ª Ejecutando tests unitarios del frontend..."
        npm test -- --watch=false --browsers=ChromeHeadless --code-coverage || echo "âš ï¸ Tests completados"

    - name: ğŸ“Š Subir artefactos del frontend
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist/
        retention-days: 30

  integration-e2e:
    name: ğŸ”— Tests E2E Integration
    runs-on: ubuntu-latest
    needs: [test-middleware, test-frontend]
    timeout-minutes: 20
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ³ Iniciar stack completo
      working-directory: ./backend
      run: |
        echo "ğŸ³ Iniciando stack completo con Docker Compose..."
        docker compose up -d
        
        echo "â³ Esperando que todos los servicios estÃ©n listos..."
        timeout 300 bash -c 'until curl -f http://localhost:8069/web/health && curl -f http://localhost:4000/health && curl -f http://localhost:4200 > /dev/null 2>&1; do 
          echo "â³ Esperando servicios... ($(date))"
          sleep 10
        done'

    - name: ğŸ”— Tests de integraciÃ³n E2E
      run: |
        echo "ğŸ”— Ejecutando tests E2E reales..."
        
        # Test de conectividad frontend
        echo "âœ… Testing Frontend (puerto 4200)..."
        curl -f http://localhost:4200
        
        # Test de conectividad middleware
        echo "âœ… Testing Middleware GraphQL (puerto 4000)..."
        curl -f http://localhost:4000/health
        
        # Test de conectividad Odoo
        echo "âœ… Testing Odoo (puerto 8069)..."
        curl -f http://localhost:8069/web/health
        
        # Test de GraphQL endpoint
        echo "âœ… Testing GraphQL endpoint..."
        curl -X POST \
          -H "Content-Type: application/json" \
          -d '{"query": "query { products { id name list_price } }"}' \
          http://localhost:4000/graphql
        
        echo "ğŸ‰ Tests E2E completados exitosamente"

    - name: ğŸ§¹ Limpiar servicios E2E
      if: always()
      working-directory: ./backend
      run: |
        echo "ğŸ§¹ Limpiando servicios Docker..."
        docker compose down -v

  build-production:
    name: ğŸš€ Build Production
    runs-on: ubuntu-latest
    needs: [test-middleware, test-frontend]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ—ï¸ Build middleware para producciÃ³n
      working-directory: ./middleware
      run: |
        echo "ğŸ—ï¸ Construyendo middleware para producciÃ³n..."
        npm ci --only=production
        npm run compile

    - name: ğŸ¨ Build frontend para producciÃ³n
      working-directory: ./frontend
      run: |
        echo "ğŸ¨ Construyendo frontend para producciÃ³n..."
        npm ci
        npm run build -- --configuration=production

    - name: ğŸ³ Build imÃ¡genes Docker para producciÃ³n
      working-directory: ./backend
      run: |
        echo "ğŸ³ Construyendo imÃ¡genes Docker..."
        docker compose build --no-cache
        
        echo "ğŸ“ Listando imÃ¡genes creadas..."
        docker images | grep galeria

    - name: ğŸ“¦ Crear artefactos de producciÃ³n
      uses: actions/upload-artifact@v4
      with:
        name: production-build
        path: |
          middleware/dist/
          frontend/dist/
          docker-compose.yml
          docker-compose.prod.yml
        retention-days: 90

    - name: ğŸ‰ Deployment preparado
      run: |
        echo "ğŸ‰ Build de producciÃ³n completado exitosamente!"
        echo "ğŸ“¦ Artefactos listos para deployment"
        echo "ğŸ³ ImÃ¡genes Docker construidas"
        echo "ğŸš€ El sistema estÃ¡ listo para ser desplegado"

  summary:
    name: ğŸ“‹ Resumen CI
    runs-on: ubuntu-latest
    needs: [test-middleware, test-frontend, build-production]
    if: always()
    
    steps:
    - name: ğŸ“‹ Mostrar resumen
      run: |
        echo "ğŸ¯ RESUMEN DEL CI PIPELINE"
        echo "========================"
        echo "âœ… Tests Middleware: ${{ needs.test-middleware.result }}"
        echo "âœ… Tests Frontend: ${{ needs.test-frontend.result }}"
        echo "âœ… Build ProducciÃ³n: ${{ needs.build-production.result }}"
        echo ""
        if [[ "${{ needs.test-middleware.result }}" == "success" && "${{ needs.test-frontend.result }}" == "success" ]]; then
          echo "ğŸ‰ Â¡CI PIPELINE COMPLETADO EXITOSAMENTE!"
          echo "ğŸš€ La GalerÃ­a Online estÃ¡ lista para deployment"
        else
          echo "âŒ CI Pipeline fallÃ³. Revisar logs arriba."
          exit 1
        fi